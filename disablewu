# Jalankan sebagai Administrator
Write-Host "=== MENONAKTIFKAN WINDOWS UPDATE ===" -ForegroundColor Cyan

# 1. Hentikan layanan
$services = @("wuauserv", "bits", "dosvc")
foreach ($svc in $services) {
    Write-Host "Menghentikan layanan: $svc..."
    Stop-Service -Name $svc -Force -ErrorAction SilentlyContinue
}

# 2. Set layanan ke Disabled
foreach ($svc in $services) {
    Write-Host "Mengatur layanan $svc ke 'Disabled'..."
    Set-Service -Name $svc -StartupType Disabled -ErrorAction SilentlyContinue
}

# 3. Nonaktifkan tugas terjadwal Windows Update
Write-Host "Menonaktifkan tugas terjadwal Windows Update..."
$tasks = @(
    "\Microsoft\Windows\WindowsUpdate\Scheduled Start",
    "\Microsoft\Windows\WindowsUpdate\sih",
    "\Microsoft\Windows\WindowsUpdate\sihboot"
)

foreach ($task in $tasks) {
    try {
        $taskPath = $task.Substring(0, $task.LastIndexOf('\') + 1)
        $taskName = $task.Split('\')[-1]
        Disable-ScheduledTask -TaskPath $taskPath -TaskName $taskName -ErrorAction Stop
        Write-Host "Tugas $task dinonaktifkan."
    } catch {
        Write-Host "Gagal menonaktifkan tugas $task (mungkin tidak ada)." -ForegroundColor Yellow
    }
}

# 4. Tambahkan entri blokir ke file hosts
Write-Host "Memblokir domain Windows Update di file hosts..."
$hostsPath = "$env:SystemRoot\System32\drivers\etc\hosts"
$blockedHosts = @(
    "windowsupdate.microsoft.com",
    "update.microsoft.com",
    "dl.delivery.mp.microsoft.com",
    "delivery.mp.microsoft.com",
    "s.update.microsoft.com",
    "fe2.update.microsoft.com",
    "fe3.delivery.dsp.mp.microsoft.com",
    "stats.update.microsoft.com"
)

# Backup file hosts
$backupPath = "$hostsPath.bak"
if (-Not (Test-Path $backupPath)) {
    Copy-Item -Path $hostsPath -Destination $backupPath -Force
    Write-Host "Backup file hosts disimpan di $backupPath"
}

# Tambahkan entri blok jika belum ada
$existingHosts = Get-Content $hostsPath -ErrorAction SilentlyContinue
$blockEntries = $blockedHosts | ForEach-Object { "127.0.0.1 `t$_" }

foreach ($entry in $blockEntries) {
    if ($existingHosts -notcontains $entry) {
        Add-Content -Path $hostsPath -Value $entry
        Write-Host "Ditambahkan: $entry"
    } else {
        Write-Host "Sudah ada: $entry"
    }
}

Write-Host "=== SELESAI ===" -ForegroundColor Green
