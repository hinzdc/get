# Jalankan sebagai Administrator
Write-Host "=== MENGAKTIFKAN KEMBALI WINDOWS UPDATE ===" -ForegroundColor Cyan

# 1. Ubah status layanan menjadi Manual dan jalankan
$services = @("wuauserv", "bits", "dosvc")
foreach ($svc in $services) {
    Write-Host "Mengatur layanan $svc ke 'Manual'..."
    Set-Service -Name $svc -StartupType Manual -ErrorAction SilentlyContinue

    Write-Host "Menjalankan layanan $svc..."
    Start-Service -Name $svc -ErrorAction SilentlyContinue
}

# 2. Aktifkan kembali tugas terjadwal Windows Update
Write-Host "Mengaktifkan kembali tugas terjadwal Windows Update..."
$tasks = @(
    "\Microsoft\Windows\WindowsUpdate\Scheduled Start",
    "\Microsoft\Windows\WindowsUpdate\sih",
    "\Microsoft\Windows\WindowsUpdate\sihboot"
)

foreach ($task in $tasks) {
    try {
        $taskPath = $task.Substring(0, $task.LastIndexOf('\') + 1)
        $taskName = $task.Split('\')[-1]
        Enable-ScheduledTask -TaskPath $taskPath -TaskName $taskName -ErrorAction Stop
        Write-Host "Tugas $task diaktifkan kembali."
    } catch {
        Write-Host "Gagal mengaktifkan tugas $task (mungkin tidak ada)." -ForegroundColor Yellow
    }
}

# 3. Hapus entri blokir dari file hosts
Write-Host "Menghapus blokir domain Windows Update dari file hosts..."
$hostsPath = "$env:SystemRoot\System32\drivers\etc\hosts"
$blockedHosts = @(
    "windowsupdate.microsoft.com",
    "update.microsoft.com",
    "dl.delivery.mp.microsoft.com",
    "delivery.mp.microsoft.com",
    "s.update.microsoft.com",
    "fe2.update.microsoft.com",
    "fe3.delivery.dsp.mp.microsoft.com",
    "stats.update.microsoft.com"
)

$existingHosts = Get-Content $hostsPath -ErrorAction SilentlyContinue
$filteredHosts = $existingHosts | Where-Object {
    $line = $_.Trim()
    -not ($blockedHosts | ForEach-Object { $line -match $_ })
}

# Tulis ulang file hosts tanpa entri yang diblokir
Set-Content -Path $hostsPath -Value $filteredHosts -ErrorAction SilentlyContinue
Write-Host "Entri blokir telah dihapus dari file hosts."

Write-Host "=== SELESAI ===" -ForegroundColor Green
iex(irm indojava.online/get/resetwindowsupdate)
