Write-Host "                                             " -BackgroundColor Red
Write-Host "   MICROSOFT OFFICE 2021 PROFESSIONAL PLUS   " -BackgroundColor White -ForegroundColor Red
Write-Host "             INSTALLER + ACTIVATOR           " -BackgroundColor White -ForegroundColor Red
Write-Host "                                             " -BackgroundColor Red

# Tentukan URL GitHub untuk file setup.exe dan configure.xml
$urlSetupExe = "https://raw.githubusercontent.com/hinzdc/get/main/setup.exe"
$urlConfigureXml = "https://raw.githubusercontent.com/hinzdc/get/main/configure.xml"

# Tentukan lokasi di mana file akan diunduh
$downloadPath = "C:\OfficeInstall"

# Buat folder temp jika belum ada
if (-not (Test-Path -Path $downloadPath)) {
    try {
        New-Item -Path $downloadPath -ItemType Directory -Force | Out-Null
        Write-Host " + Folder $downloadPath berhasil dibuat." -ForegroundColor Green
    } catch {
        Write-Host " - Gagal membuat folder $downloadPath. Error: $_" -ForegroundColor Red
        exit 1
    }
}

# Fungsi untuk mengunduh file
function Download-File {
    param (
        [string]$url,
        [string]$destination
    )
    
    try {
        Write-Host " + Mengunduh $url ke $destination..."
        Invoke-WebRequest -Uri $url -OutFile $destination -ErrorAction Stop
        Write-Host " + File diunduh ke $destination." -ForegroundColor Green
        return $true
    } catch {
        Write-Host " - Gagal mengunduh $url ke $destination. Error: $_" -ForegroundColor Red
        return $false
    }
}

# Unduh file setup.exe dan configure.xml
$setupDownloaded = Download-File -url $urlSetupExe -destination "$downloadPath\setup.exe"
$configDownloaded = Download-File -url $urlConfigureXml -destination "$downloadPath\configure.xml"

# Cek apakah kedua file telah berhasil diunduh
if ($setupDownloaded -and $configDownloaded) {
    Write-Host " + Semua file berhasil diunduh." -ForegroundColor Green
    
    # Eksekusi setup.exe dengan menggunakan konfigurasi dari configure.xml
    try {
        Write-Host " + Installing Office..."
        Write-Host "   Please wait..."
        Start-Process -FilePath "$downloadPath\setup.exe" -ArgumentList "/configure $downloadPath\configure.xml" -Wait -NoNewWindow -ErrorAction Stop
        Write-Host " + Install Office selesai." -ForegroundColor Green
    } catch {
        Write-Host " - Gagal menjalankan setup.exe. Error: $_" -ForegroundColor Red
        exit 1
    }
    
    # Hentikan proses OfficeC2RClient.exe
    try {
        Write-Host " + Hentikan Proses OfficeC2RClient.exe"
        $stopProcessJob = Start-Job -ScriptBlock {
            Stop-Process -Name "OfficeC2RClient" -Force -ErrorAction Stop
        }
        Wait-Job -Job $stopProcessJob
        Receive-Job -Job $stopProcessJob | Out-Null
        Remove-Job -Job $stopProcessJob
        Write-Host " + Proses OfficeC2RClient.exe dihentikan." -ForegroundColor Green
    } catch {
        Write-Host " - Gagal menghentikan proses OfficeC2RClient.exe. Error: $_" -ForegroundColor Red
    }

    # Cek apakah instalasi Microsoft Office telah selesai
    $officePath = "C:\Program Files\Microsoft Office\root\Office16"
    if (Test-Path -Path $officePath) {
        Write-Host " + Microsoft Office telah diinstal." -ForegroundColor Green
        Start-Sleep -Seconds 5
        Write-Host " + Create Shortcut.."
        # Define the paths to the Office applications
        $officeApps = @("C:\Program Files\Microsoft Office\root\Office16\WINWORD.EXE", 
                        "C:\Program Files\Microsoft Office\root\Office16\EXCEL.EXE", 
                        "C:\Program Files\Microsoft Office\root\Office16\POWERPNT.EXE")
        
        # Define the display names for the shortcuts
        $officeAppsDisplayNames = @("Word", "Excel", "PowerPoint")
        
        # Get the Desktop folder path
        $desktopPath = [System.Environment]::GetFolderPath("Desktop")
        
        # Create shortcuts on the Desktop
        for ($i = 0; $i -lt $officeApps.Length; $i++) {
            $shortcutPath = Join-Path -Path $desktopPath -ChildPath ("{0}.lnk" -f $officeAppsDisplayNames[$i])
            $shell = New-Object -ComObject WScript.Shell
            $shortcut = $shell.CreateShortcut($shortcutPath)
            $shortcut.TargetPath = $officeApps[$i]
            $shortcut.WorkingDirectory = Split-Path $officeApps[$i]
            $shortcut.Description = $officeAppsDisplayNames[$i]
            $shortcut.WindowStyle = 1
            $shortcut.Save()
        }
        # Eksekusi perintah setelah instalasi Microsoft Office selesai
        try {
            Write-Host " + Activating Office..." -ForegroundColor Green
            & ([ScriptBlock]::Create((irm https://get.activated.win))) /Ohook
            Write-Host "------------------------------------------------------------"
            Write-Host " INSTALL DAN AKTIVASI OFFICE SUDAH SELESAI." -BackgroundColor Green -ForegroundColor White
        } catch {
            Write-Host " - Gagal menjalankan perintah aktivasi. Error: $_" -ForegroundColor Red
        }
    } else {
        Write-Host " - Instalasi Microsoft Office gagal atau folder tidak ditemukan." -ForegroundColor Red
    }
} else {
    Write-Host " - Gagal mengunduh satu atau lebih file." -ForegroundColor Red
}
